extends:
  - spectral:asyncapi

rules:

  ############################
  # ESTRUCTURA
  ############################

  # categoria: Estructura - ID de la API válido
  api-id-valid:
    description: "El id de la API debe ser la URL del repositorio GitHub del producer."
    severity: error
    given: "$"
    then:
      field: id
      function: pattern
      functionOptions:
        match: "^https://github\\.com/.*"

  # categoria: Estructura - Título de la API presente y descriptivo
  api-title-present:
    description: "La especificación debe tener un título (info.title) con más de 10 caracteres."
    severity: error
    given: "$.info"
    then:
      field: title
      function: length
      functionOptions:
        min: 11

  # categoria: Estructura - Versión de la API presente
  api-version-present:
    description: "La especificación debe incluir info.version."
    severity: error
    given: "$.info"
    then:
      field: version
      function: truthy

  # categoria: Estructura - Versión de AsyncAPI
  asyncapi-version:
    description: "La especificación debe indicar que usa la versión 3.0.0 o superior de AsyncAPI."
    severity: error
    given: "$"
    then:
      field: asyncapi
      function: pattern
      functionOptions:
        match: "^3\\..*"

  # categoria: Estructura - Canales definidos
  channels-defined:
    description: "Debe existir al menos un canal en la sección channels."
    severity: error
    given: "$.channels"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Operaciones definidas
  operations-defined:
    description: "Debe existir al menos una operación (operations)."
    severity: error
    given: "$.operations"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Acción de la operación válida (send/receive)
  operation-action-valid:
    description: "La acción de cada operación debe ser 'send' o 'receive'."
    severity: error
    given: "$.operations[*]"
    then:
      field: action
      function: enumeration
      functionOptions:
        values: ["send", "receive"]

  # categoria: Estructura - Mensajes definidos en cada canal
  channel-messages-defined:
    description: "Cada canal debe tener al menos un mensaje definido."
    severity: error
    given: "$.channels[*]"
    then:
      field: messages
      function: truthy

  # categoria: Estructura - Payload del mensaje definido
  message-payload-defined:
    description: "Cada mensaje debe incluir un payload."
    severity: error
    given: "$.components.messages[*]"
    then:
      field: payload
      function: truthy

  # categoria: Estructura - Schemas definidos
  schemas-defined:
    description: "La especificación debe definir al menos un schema en components.schemas."
    severity: error
    given: "$.components.schemas"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Tipo de schema 'object'
  schema-type-object:
    description: "Cada schema debe tener el type igual a 'object'."
    severity: error
    given: "$.components.schemas[*]"
    then:
      field: type
      function: enumeration
      functionOptions:
        values: ["object"]

  # categoria: Estructura - Propiedades del schema definidas
  schema-properties-defined:
    description: "Cada schema debe contar con al menos una propiedad en su sección properties."
    severity: error
    given: "$.components.schemas[*].properties"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Propiedades del schema con tipo
  schema-properties-with-type:
    description: "Cada propiedad de los schemas debe especificar un tipo."
    severity: error
    given: "$.components.schemas[*].properties[*]"
    then:
      field: type
      function: truthy

  # categoria: Estructura - Booleans no nulos
  boolean-not-null:
    description: "Los campos booleanos no pueden tener valor null."
    severity: error
    given: "$..*[?(@.type=='boolean')]"
    then:
      field: nullable
      function: falsy

  # categoria: Estructura - No incluir JSON en campos String
  no-json-in-string:
    description: "Si se requiere un objeto JSON, definirlo como type: object, no como una cadena con JSON embebido."
    severity: error
    given: "$..*[?(@.type=='string')]"
    then:
      field: example
      function: pattern
      functionOptions:
        notMatch: "^\\s*[{\\[].*[}\\]]\\s*$"

  # categoria: Estructura - Uso de Message Traits (Headers)
  message-traits-exist:
    description: "Los traits para headers (commonHeaders, transportHeaders, businessHeaders, trackingHeaders) deben existir."
    severity: error
    given: "$.components.messageTraits"
    then:
      function: schema
      functionOptions:
        schema:
          required:
            - commonHeaders
            - transportHeaders
            - businessHeaders
            - trackingHeaders

  ############################
  # HEADERS
  ############################

  # categoria: Headers - Headers obligatorios comunes, transporte, negocio y tracking
  mandatory-headers:
    description: "Se deben cumplir todos los headers obligatorios definidos por la empresa."
    severity: error
    given: "$.components.messageTraits"
    then:
      function: schema
      functionOptions:
        schema:
          properties:
            commonHeaders:
              required: [eventId, eventType, entityId, entityType, timestamp, datetime, version, internal]
            transportHeaders:
              required: [channel]
            businessHeaders:
              required: [domain, subdomain, businessCapability]
            trackingHeaders:
              required: [traceId, spanId]

  ############################
  # FORMATO
  ############################

  # categoria: Formato - No incluir valores nulos o vacíos
  no-null-or-empty-values:
    description: "Se deben evitar valores null o cadenas vacías en la especificación."
    severity: warning
    given: "$..*"
    then:
      function: falsy

  ############################
  # NOMENCLATURA
  ############################

  # categoria: Nomenclatura - lowerCamelCase
  lower-camel-case:
    description: "Los nombres de campos, propiedades y mensajes deben seguir la convención lowerCamelCase."
    severity: error
    given: "$..properties.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[a-z][a-zA-Z0-9]*$"
