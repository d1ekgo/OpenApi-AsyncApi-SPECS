extends:
  - spectral:asyncapi

rules:

  ############################
  # ESTRUCTURA
  ############################

  # categoria: Estructura - ID de la API válido
  estructura-id-api-valido:
    description: "El id de la API debe ser la URL del repositorio GitHub del producer."
    severity: error
    given: "$"
    then:
      field: id
      function: pattern
      functionOptions:
        match: "^https://github\\.com/.*"

  # categoria: Estructura - Título de la API presente y descriptivo
  estructura-titulo-api-presente:
    description: "La especificación debe tener un título (info.title) con más de 10 caracteres."
    severity: error
    given: "$.info"
    then:
      field: title
      function: length
      functionOptions:
        min: 11

  # categoria: Estructura - Versión de la API presente
  estructura-version-api-presente:
    description: "La especificación debe incluir info.version."
    severity: error
    given: "$.info"
    then:
      field: version
      function: truthy

  # categoria: Estructura - Versión de AsyncAPI
  estructura-version-asyncapi:
    description: "La especificación debe indicar que usa la versión 3.0.0 o superior de AsyncAPI."
    severity: error
    given: "$"
    then:
      field: asyncapi
      function: pattern
      functionOptions:
        match: "^3\\..*"

  # categoria: Estructura - Canales definidos
  estructura-canales-definidos:
    description: "Debe existir al menos un canal en la sección channels."
    severity: error
    given: "$.channels"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Operaciones definidas
  estructura-operaciones-definidas:
    description: "Debe existir al menos una operación (operations)."
    severity: error
    given: "$.operations"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Acción de la operación válida (send/receive)
  estructura-accion-operacion-valida:
    description: "La acción de cada operación debe ser 'send' o 'receive'."
    severity: error
    given: "$.operations[*]"
    then:
      field: action
      function: enumeration
      functionOptions:
        values: ["send", "receive"]

  # categoria: Estructura - Mensajes definidos en cada canal
  estructura-mensajes-por-canal:
    description: "Cada canal debe tener al menos un mensaje definido."
    severity: error
    given: "$.channels[*]"
    then:
      field: messages
      function: truthy

  # categoria: Estructura - Payload del mensaje definido
  estructura-payload-mensaje:
    description: "Cada mensaje debe incluir un payload."
    severity: error
    given: "$.components.messages[*]"
    then:
      field: payload
      function: truthy

  # categoria: Estructura - Schemas definidos
  estructura-schemas-definidos:
    description: "La especificación debe definir al menos un schema en components.schemas."
    severity: error
    given: "$.components.schemas"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Tipo de schema 'object'
  estructura-schema-tipo-object:
    description: "Cada schema debe tener el type igual a 'object'."
    severity: error
    given: "$.components.schemas[*]"
    then:
      field: type
      function: enumeration
      functionOptions:
        values: ["object"]

  # categoria: Estructura - Propiedades del schema definidas
  estructura-schema-propiedades-definidas:
    description: "Cada schema debe contar con al menos una propiedad en su sección properties."
    severity: error
    given: "$.components.schemas[*].properties"
    then:
      function: schema
      functionOptions:
        schema:
          minProperties: 1

  # categoria: Estructura - Propiedades del schema con tipo
  estructura-schema-propiedades-con-tipo:
    description: "Cada propiedad de los schemas debe especificar un tipo."
    severity: error
    given: "$.components.schemas[*].properties[*]"
    then:
      field: type
      function: truthy

  # categoria: Estructura - Booleans no nulos
  estructura-booleans-no-nulos:
    description: "Los campos booleanos no pueden tener valor null."
    severity: error
    given: "$..*[?(@.type=='boolean')]"
    then:
      field: nullable
      function: falsy

  # categoria: Estructura - No incluir JSON en campos String
  estructura-no-json-en-string:
    description: "Si se requiere un objeto JSON, definirlo como type: object, no como una cadena con JSON embebido."
    severity: error
    given: "$..*[?(@.type=='string')]"
    then:
      field: example
      function: pattern
      functionOptions:
        notMatch: "^\\s*[{\\[].*[}\\]]\\s*$"

  # categoria: Estructura - Uso de Message Traits (Headers)
  estructura-message-traits:
    description: "Los traits para headers (commonHeaders, transportHeaders, businessHeaders, trackingHeaders) deben existir."
    severity: error
    given: "$.components.messageTraits"
    then:
      function: schema
      functionOptions:
        schema:
          required:
            - commonHeaders
            - transportHeaders
            - businessHeaders
            - trackingHeaders

  ############################
  # HEADERS
  ############################

  # categoria: Headers - Headers comunes: eventId presente
  headers-eventid:
    description: "El header común `eventId` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: eventId
      function: truthy

  # categoria: Headers - Headers comunes: eventType presente
  headers-eventtype:
    description: "El header común `eventType` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: eventType
      function: truthy

  # categoria: Headers - Headers comunes: entityId presente
  headers-entityid:
    description: "El header común `entityId` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: entityId
      function: truthy

  # categoria: Headers - Headers comunes: entityType presente
  headers-entitytype:
    description: "El header común `entityType` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: entityType
      function: truthy

  # categoria: Headers - Headers comunes: timestamp presente
  headers-timestamp:
    description: "El header común `timestamp` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: timestamp
      function: truthy

  # categoria: Headers - Headers comunes: datetime presente
  headers-datetime:
    description: "El header común `datetime` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: datetime
      function: truthy

  # categoria: Headers - Headers comunes: version presente
  headers-version:
    description: "El header común `version` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: version
      function: truthy

  # categoria: Headers - Headers comunes: internal presente
  headers-internal:
    description: "El header común `internal` es obligatorio."
    severity: error
    given: "$.components.messageTraits.commonHeaders.properties"
    then:
      field: internal
      function: truthy

  # categoria: Headers - Header de transporte 'channel' presente
  headers-transport-channel:
    description: "Asegurar que `transportHeaders` incluya al menos la clave `channel`."
    severity: error
    given: "$.components.messageTraits.transportHeaders.properties"
    then:
      field: channel
      function: truthy

  # categoria: Headers - Headers de negocio presentes y válidos
  headers-business:
    description: "En `businessHeaders`, deben existir `domain`, `subdomain`, `businessCapability`."
    severity: error
    given: "$.components.messageTraits.businessHeaders.properties"
    then:
      function: schema
      functionOptions:
        schema:
          required: [domain, subdomain, businessCapability]

  # categoria: Headers - Headers de seguimiento presentes
  headers-tracking:
    description: "En `trackingHeaders`, deben existir `traceId` y `spanId` (parentSpanId es opcional)."
    severity: error
    given: "$.components.messageTraits.trackingHeaders.properties"
    then:
      function: schema
      functionOptions:
        schema:
          required: [traceId, spanId]

  ############################
  # FORMATO
  ############################

  # categoria: Formato - Documento JSON/YAML válido y bien indentado
  formato-documento-valido:
    description: "El documento debe ser parseable y estar correctamente indentado."
    severity: error
    given: "$"
    then:
      function: truthy

  # categoria: Formato - Uso correcto de comillas dobles en JSON
  formato-comillas-dobles-json:
    description: "En JSON, las cadenas deben llevar comillas dobles, no simples."
    severity: error
    given: "$"
    then:
      function: truthy

  # categoria: Formato - Uso adecuado de llaves y corchetes
  formato-llaves-corchetes:
    description: "Los objetos deben usar `{}` y los arrays `[]`, sin mezclar formatos."
    severity: error
    given: "$"
    then:
      function: truthy

  # categoria: Formato - Separación de claves y valores
  formato-separacion-claves-valores:
    description: "En JSON, los campos deben separarse correctamente con `:` y `,`."
    severity: error
    given: "$"
    then:
      function: truthy

  # categoria: Formato - No incluir valores nulos o vacíos
  formato-no-null-vacio:
    description: "Se deben evitar valores `null` o cadenas vacías en la especificación."
    severity: warning
    given: "$..*"
    then:
      function: falsy

  # categoria: Formato - Campos y propiedades en inglés
  formato-campos-ingles:
    description: "Todas las llaves de schemas, messages y properties deben estar en inglés."
    severity: error
    given: "$..properties.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[A-Za-z][A-Za-z0-9]*$"

  ############################
  # NOMENCLATURA
  ############################

  # categoria: Nomenclatura - lowerCamelCase
  nomenclatura-lowercamelcase:
    description: "Los nombres de campos, propiedades y mensajes deben seguir la convención lowerCamelCase."
    severity: error
    given: "$..properties.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[a-z][a-zA-Z0-9]*$"

  # categoria: Nomenclatura - Nombres de arrays en plural
  nomenclatura-arrays-plural:
    description: "Las propiedades con type: array deben terminar en \"s\"."
    severity: warning
    given: "$..properties[*]"
    then:
      field: type
      function: pattern
      functionOptions:
        match: "array"

  # categoria: Nomenclatura - Claves JSON sin números al principio
  nomenclatura-sin-numero-inicial:
    description: "Ninguna clave debe comenzar con un número."
    severity: error
    given: "$..properties.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[^0-9].*"

  # categoria: Nomenclatura - No usar palabras reservadas
  nomenclatura-no-palabras-reservadas:
    description: "Prohibido el uso de palabras como message, body, payload, class, default, function."
    severity: error
    given: "$..properties.*~"
    then:
      function: enumeration
      functionOptions:
        values: ["message","body","payload","class","default","function"]
